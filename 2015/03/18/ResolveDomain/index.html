<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>有关域名解析 | 牛肉培根冒菜侠</title>
  <meta name="description" content="A minimal hexo theme." />
  <meta name="keywords" content="hexo,theme,typescript,otakism,otaku" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="这里纪录一下服务端环境，单个域名在对应的多条IP信息情况下，配置与解析处理。">
<meta property="og:type" content="article">
<meta property="og:title" content="有关域名解析">
<meta property="og:url" content="https://jiangink.github.io/2015/03/18/ResolveDomain/index.html">
<meta property="og:site_name" content="牛肉培根冒菜侠">
<meta property="og:description" content="这里纪录一下服务端环境，单个域名在对应的多条IP信息情况下，配置与解析处理。">
<meta property="og:updated_time" content="2017-03-26T09:49:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="有关域名解析">
<meta name="twitter:description" content="这里纪录一下服务端环境，单个域名在对应的多条IP信息情况下，配置与解析处理。">
  
  
    <link rel="icon" href="/favicon.png">
  

	<script src="https://use.typekit.net/eyf3hir.js"></script>
  <script>try{Typekit.load({ async: false });}catch(e){}</script>
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
  

</head>

<body>
  
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>

  <script>setLoadingBarProgress(20)</script>
  
  <div id="site-wrapper">
    
    <header id="header">
	<div id="header-wrapper" class="clearfix">
		<a id="logo" href="/">
			<img src="/images/logo.png" />
			<span id="site-desc">
			  otaku keeps alive
      </span>
		</a>
		<button id="site-nav-switch">
	    <span class="icon icon-menu"></span>
	  </button>
	</div>
	<aside id="site-menu">
  	<nav>
  		
        <a href="/" class="nav-home nav">
          Home
        </a>
      
        <a href="/about" class="nav-about nav">
          About
        </a>
      
        <a href="/archives" class="nav-archives nav">
          Archives
        </a>
      
    </nav>
	</aside>
</header>
    <script>setLoadingBarProgress(40);</script>
    
    <main id="main" role="main">
      <article id="post-ResolveDomain"
  class="post article white-box article-type-post"
  itemscope itemprop="blogPost">
	<h2 class="title">
  	<a href="/2015/03/18/ResolveDomain/">
    	有关域名解析
    </a>
  </h2>
	<time>
	  3月 18, 2015
	</time>
	<section class="content">
  	<div class="article-entry" itemprop="articleBody">
    	<p><em>这里纪录一下服务端环境，单个域名在对应的多条IP信息情况下，配置与解析处理。</em></p>
<a id="more"></a>
<h4 id="1、关于hosts允许主机对应多条IP的参数配置"><a href="#1、关于hosts允许主机对应多条IP的参数配置" class="headerlink" title="1、关于hosts允许主机对应多条IP的参数配置"></a>1、关于hosts允许主机对应多条IP的参数配置</h4><hr>
<p>我们知道 <em>gethostbyname()</em> 函数会使用到 hosts 文件进行域名解析，而在解析过程中将按照顺序读取文件内容；</p>
<p>hosts文件内容如下所示： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /etc/hosts</span></div><div class="line">192.168.1.1		www.dns.com</div><div class="line">192.168.1.2		www.dns.com</div><div class="line">192.168.1.3		www.dns.com</div><div class="line">192.168.1.4		www.dns.com</div><div class="line">``` </div><div class="line"></div><div class="line">一般情况下，若未做任何host参数配置的话，仅能够解析到第一条内容(即：192.168.1.1)，</div><div class="line">但如果在 */etc/host.conf* 配置文件中添加 *multi on* (允许主机存在多条IP)，则能够解析到关于该域名的多条IP信息；</div><div class="line"></div><div class="line"><span class="comment">#### 2、主机信息及IP地址列表</span></div><div class="line">---</div><div class="line">hostent(host entry)，该结构体记录主机的信息，包括主机名、别名、地址类型、地址长度和地址列表。之所以主机的地址是一个列表的形式，原因是当一个主机对应多个网络接口时，就存在多个地址。</div><div class="line">```cpp</div><div class="line">    struct hostent</div><div class="line">    &#123;</div><div class="line">        char*	h_name;         /* official name of host */</div><div class="line">        char*	h_aliases;      /* <span class="built_in">alias</span> list */</div><div class="line">        short	h_addrtype;     /* host address <span class="built_in">type</span> */</div><div class="line">        short	h_length;       /* length of address */</div><div class="line">        char**	h_addr_list;    /* list of addresses */</div><div class="line"><span class="comment">#define	h_addr	h_addr_list[0]  /* address, for backward compat */</span></div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<p><em>h_addr_list</em> 为指针数组，数组中每个元素都是 <em>in_addr</em> 型指针。</p>
<p>具体域名IP解析的代码如下：</p>
<pre><code class="cpp"><span class="function"><span class="keyword">void</span> <span class="title">resolve_domain_name</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span>* host_name)</span>
</span>{
    <span class="keyword">struct</span> hostent *host_info = <span class="literal">NULL</span>;
    <span class="keyword">char</span> target_ip[<span class="number">32</span>];
    <span class="keyword">char</span> **pptr;
    <span class="keyword">char</span> *address = <span class="literal">NULL</span>;

    <span class="built_in">memset</span>(target_ip, <span class="number">0</span>, <span class="keyword">sizeof</span>(target_ip));
    <span class="comment">//获取主机信息</span>
    host_info = gethostbyname(host_name);
    <span class="keyword">if</span> (<span class="literal">NULL</span> == host_info)
    {
        <span class="built_in">printf</span>(<span class="string">"DNS resolve error![%s]\n"</span>, host_name);
        <span class="keyword">return</span>;
    }

    <span class="comment">//获取IP地址列表</span>
    pptr = host_info-&gt;h_addr_list;
    <span class="keyword">while</span>(<span class="literal">NULL</span> != *pptr)
    {
        <span class="comment">//[二进制整数] 转换为 [点分十进制]</span>
        address = inet_ntoa(*(<span class="keyword">struct</span> in_addr *)*pptr);
        <span class="comment">//address = inet_ntop(host_info-&gt;h_addrtype, *pptr, target_ip, sizeof(target_ip));</span>
        <span class="keyword">if</span> (<span class="literal">NULL</span> == address)
        {
            <span class="built_in">printf</span>(<span class="string">"Addr convert error!\n"</span>);
            <span class="keyword">return</span>;
        }
        <span class="built_in">printf</span>(<span class="string">"IP Address = [%s]\n"</span>, address);
        pptr ++;
    }
}
</code></pre>
<p>嗯，到这里，另外需要补充的是二进制整数转点分十进制时，“inet_ntoa函数陷阱”的问题，<br>inet_ntoa() 函数返回值为一个指向字符的指针，且是一个由inet_ntoa()函数控制的静态固定指针，<br>在每次调用 inet_ntoa() 后，它将会覆盖上次调用时所得的IP地址。<br>所以如果上一次返回的结果仍然需要，则最好定义一个缓存来做保留。</p>

  	</div>

	  <div class="article-tags tags">
		  
        <a class="tag-link" href="/tags/C/">C</a><a class="tag-link" href="/tags/DNS/">DNS</a>
      
	  </div>
	</section>
</article>




      <script>setLoadingBarProgress(60);</script>
    </main>
    
    <footer id="footer" class="clearfix">
  
  
	<div class="search">
	  <form name="searchform" id="searchform" class="u-search-form">
	    <input type="text" id="searchinput" class="u-search-input" placeholder="Looking for something?" />
	    <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit">
	      <span class="icon icon-search"></span>
	    </button>
	  </form>
	</div>
	

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/artchen" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="https://twitter.com/otakism" class="social twitter"
          target="_blank" rel="external">
          <span class="icon icon-twitter"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
        <a href="https://plus.google.com/+ArtChenOtakism/posts" class="social google"
          target="_blank" rel="external">
          <span class="icon icon-google"></span>
        </a>
      
        <a href="http://weibo.com/otakism/" class="social sina-weibo"
          target="_blank" rel="external">
          <span class="icon icon-sina-weibo"></span>
        </a>
      
    
  </div>
  
  <div>Theme <span class="codename">Typescript</span> designed by <a href="http://rakugaki.me/" target="_blank">Art Chen</a>.</div>
  <div>&copy; <a href="/">牛肉培根冒菜侠</a></div>
  
</footer>


    <script>setLoadingBarProgress(80);</script>
    
  </div>

  



<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/jquery.min.js"><\/script>')</script>

<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "google";
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
  
</body>
</html>
